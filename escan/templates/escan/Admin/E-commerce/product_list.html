{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link rel="icon" href="{% static 'assets/LogoW.png' %}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --dark-brown: #2F1609;
            --medium-brown: #704210;
            --light-brown: #96500E;
            --gold: #DA9408;
            --light-gold: #FBD576;
            --bright-gold: #FBD242;
            --white: #FFFFFF;
            --light-bg: #FFF9EC;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(to bottom, var(--medium-brown), var(--light-brown));
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        }

        .logo-container {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(251, 213, 118, 0.3);
        }

        .logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--bright-gold);
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(218, 148, 8, 0.3);
        }

        .menu {
            padding: 20px 0;
        }

        .menu a {
            display: block;
            color: var(--light-gold);
            padding: 12px 25px;
            text-decoration: none;
            font-size: 20px;
            font-weight: 500;
            transition: all 0.3s;
            margin: 5px 10px;
            border-radius: 8px;
        }

        .menu a:hover, .menu a.active {
            background: linear-gradient(to right, var(--gold), transparent);
            color: var(--white);
            transform: translateX(5px);
        }

        .menu a i {
            width: 24px;
            text-align: center;
            margin-right: 10px;
        }

        .content {
            margin-left: 280px;
            flex: 1;
            padding: 25px;
            transition: all 0.3s;
        }

        .nav-bar {
            background-color: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title {
            font-size: 25px;
            font-weight: 600;
            color: var(--medium-brown);
            margin: 0;
            position: relative;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 50px;
            height: 3px;
            background: linear-gradient(to right, var(--gold), var(--bright-gold));
        }

        .search-box {
            display: flex;
            font-size: 20px;
            align-items: center;
            background-color: rgba(255,255,255,0.9);
            border-radius: 30px;
            padding: 5px 15px;
            border: 1px solid rgba(112, 66, 16, 0.2);
            transition: all 0.3s;
        }

        .search-box:focus-within {
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(218, 148, 8, 0.2);
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            padding: 8px;
            width: 200px;
        }

        .search-box button {
            background: none;
            border: none;
            color: var(--gold);
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            border-radius: 8px;
            font-size: 20px;
            font-weight: 500;
            transition: all 0.3s;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--gold), var(--bright-gold));
            border: none;
            color: var(--white);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(218, 148, 8, 0.4);
        }

        .btn-secondary {
            background-color: var(--medium-brown);
            border: none;
            color: var(--white);
        }

        .btn-success {
            background-color: #28a745;
            border: none;
            color: var(--white);
        }

        .btn-warning {
            background-color: var(--gold);
            border: none;
            color: var(--white);
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
            color: var(--white);
        }

        .btn-dark {
            background-color: var(--dark-brown);
            border: none;
            color: var(--white);
        }

        .table-container {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            padding: 20px;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: separate;
            font-size: 20px;
            border-spacing: 0;
        }

        .table th {
            background: linear-gradient(to right, var(--medium-brown), var(--light-brown));
            color: var(--white);
            padding: 15px;
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(112, 66, 16, 0.1);
            vertical-align: middle;
        }

        .table tr:hover td {
            background-color: rgba(251, 213, 118, 0.1);
        }

        .tb-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid rgba(112, 66, 16, 0.1);
        }

        .actions-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .actions-btn:hover {
            transform: translateY(-1px);
        }

        .btn-edit {
            font-size: 20px;
            background-color: var(--gold);
            color: var(--white);
        }

        .btn-delete {
            font-size: 20px;
            background-color: #dc3545;
            color: var(--white);
        }

        .description {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .description:hover {
            white-space: normal;
            overflow: visible;
            position: relative;
            z-index: 10;
            background-color: var(--white);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .burger {
            display: none;
            cursor: pointer;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background-color: var(--gold);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .burger div {
            width: 25px;
            height: 3px;
            background-color: var(--white);
            margin: 4px 0;
            transition: all 0.3s ease;
        }

        .burger.active div:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .burger.active div:nth-child(2) {
            opacity: 0;
        }

        .burger.active div:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        .alert {
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .modal-header {
            background: linear-gradient(to right, var(--medium-brown), var(--light-brown));
            color: var(--white);
            border-radius: 12px 12px 0 0;
        }

        .modal-title {
            font-weight: 500;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .form-control:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 0.25rem rgba(218, 148, 8, 0.25);
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .content {
                margin-left: 0;
            }
            
            .burger {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .nav-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
                margin: 10px 0;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 576px) {
            .content {
                padding: 15px;
            }
            
            .table th, .table td {
                padding: 8px;
                font-size: 14px;
            }
            
            .tb-image {
                width: 40px;
                height: 40px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .table-container {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="burger" id="burger" onclick="toggleNav()">
        <div></div>
        <div></div>
        <div></div>
    </div>
    
    <nav class="sidebar" id="sidebar">
        <div class="logo-container">
            <img src="{% static 'img/LogoW.png' %}" alt="Logo" class="logo">
        </div>
        <div class="menu">
            <a href="{% url 'admin_dashboard' %}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="{% url 'product_list' %}" class="active"><i class="fas fa-store-alt"></i> My Store</a>
            <a href="{% url 'a_market_place' %}"><i class="fas fa-store"></i> Market Place</a>
            <a href="{% url 'validation_list' %}"><i class="fas fa-briefcase"></i> Store Applicants</a>
            <a href="{% url 'orders_part' %}"><i class="fas fa-shopping-cart"></i> Orders</a>
            <a href="{% url 'customer_table' %}"><i class="bi bi-people-fill"></i> Customers</a>
            <a href="{% url 'a_scan' %}"><i class="fas fa-qrcode"></i> Scan</a>
            <a href="{% url 'a_scan' %}#knowledge-section"><i class="fas fa-book-reader"></i> Library</a>
            <a href="#"><i class="fas fa-file-alt"></i> History</a>
        </div>
    </nav>
    
    <div class="content">
        <div class="nav-bar">
            <h2 class="page-title">PRODUCT LIST</h2>
        
            <div class="action-buttons">
                <div class="search-box">
                <input type="text" id="searchBox" placeholder="Search products...">
                <button onclick="searchProduct()"><i class="fas fa-search"></i></button>
                    </div>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#storeModal">
                    <i class="fas fa-store"></i> {% if has_store %}Edit Store{% else %}Create Store{% endif %}
                </button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal" {% if not has_store %}disabled{% endif %}>
                    <i class="fas fa-plus-circle"></i> Add Product
                </button>
                <a href="{% url 'category_list' %}" class="btn btn-warning">
                    <i class="fas fa-tags"></i> Categories
                </a>
                <button class="btn btn-info" onclick="printProducts()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-dark" onclick="undoAction()">
                    <i class="fas fa-undo"></i> Undo
                </button>
            </div>
        </div>
        
        <div class="table-container">
            {% if messages %}
            <div class="alert-container mb-3">
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                    <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% else %}check-circle{% endif %}"></i> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if products %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th class="description">Description</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Image</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td>{{ product.name }}</td>
                        <td>{{ product.category.name|default:"-" }}</td>
                        <td class="description" title="{{ product.description }}">{{ product.description|truncatechars:50|default:"-" }}</td>
                        <td>₱{{ product.price }}</td>
                        <td>{{ product.stock }}</td>
                        <td>
                            <img class="tb-image" src="{{ product.image_url|default:'/static/img/no-image.png' }}" alt="{{ product.name }}">
                        </td>
                        <td>
                            <button class="btn btn-edit actions-btn" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.id }}">
                                <i class="bi bi-pencil-square"></i> Edit
                            </button>
                            <button class="btn btn-delete actions-btn" onclick="confirmDelete({{ product.id }})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                {% if has_store %}
                No products found. Click "Add Product" to get started.
                {% else %}
                You need to create a store before you can add products.
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

 <!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="addProductForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_name" class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="id_name" name="name" required>
                                <div class="invalid-feedback" id="name-error"></div>
                            </div>
                            <div class="mb-3">
                                <label for="id_category" class="form-label">Category *</label>
                                <select class="form-control" id="id_category" name="category" required>
                                    <option value="">Select a category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback" id="category-error"></div>
                            </div>
                            <div class="mb-3">
                                <label for="id_price" class="form-label">Price *</label>
                                <div class="input-group">
                                    <span class="input-group-text">₱</span>
                                    <input type="number" class="form-control" id="id_price" name="price" step="0.01" min="0" required>
                                </div>
                                <div class="invalid-feedback" id="price-error"></div>
                            </div>
                            <div class="mb-3">
                                <label for="id_stock" class="form-label">Stock *</label>
                                <input type="number" class="form-control" id="id_stock" name="stock" min="0" required>
                                <div class="invalid-feedback" id="stock-error"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_description" class="form-label">Description</label>
                                <textarea class="form-control" id="id_description" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="id_image_url" class="form-label">Product Image</label>
                                <input type="file" class="form-control" id="id_image_url" name="image_url" accept="image/*">
                                <div class="form-text">Max size: 5MB. Supported formats: JPG, PNG, GIF</div>
                                <div class="invalid-feedback" id="image_url-error"></div>
                            </div>
                            <div class="image-preview mb-3 text-center">
                                <img id="imagePreview" src="#" alt="Image Preview" class="img-thumbnail d-none" style="max-height: 150px;">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="spinner" role="status" aria-hidden="true"></span>
                            Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

    <!-- Edit Product Modals -->
    {% for product in products %}
    <div class="modal fade" id="editProductModal{{ product.id }}" tabindex="-1" aria-labelledby="editProductModalLabel{{ product.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel{{ product.id }}">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" enctype="multipart/form-data" action="{% url 'edit_product' product.id %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_name{{ product.id }}" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="edit_name{{ product.id }}" name="name" value="{{ product.name }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_category{{ product.id }}" class="form-label">Category *</label>
                                    <select class="form-control" id="edit_category{{ product.id }}" name="category" required>
                                        <option value="">Select a category</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if product.category.id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_price{{ product.id }}" class="form-label">Price *</label>
                                    <input type="number" class="form-control" id="edit_price{{ product.id }}" name="price" step="0.01" min="0" value="{{ product.price }}" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_stock{{ product.id }}" class="form-label">Stock *</label>
                                    <input type="number" class="form-control" id="edit_stock{{ product.id }}" name="stock" min="0" value="{{ product.stock }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="edit_description{{ product.id }}" class="form-label">Description</label>
                                    <textarea class="form-control" id="edit_description{{ product.id }}" name="description" rows="3">{{ product.description }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_image_url{{ product.id }}" class="form-label">Product Image</label>
                                    <input type="file" class="form-control" id="edit_image_url{{ product.id }}" name="image_url" accept="image/*">
                                    <div class="form-text">Leave blank to keep current image</div>
                                </div>
                                <div class="current-image mb-3 text-center">
                                    {% if product.image_url %}
                                    <p>Current Image:</p>
                                    <img src="{{ product.image_url }}" alt="Current Product Image" class="img-thumbnail" style="max-height: 150px;">
                                    {% else %}
                                    <p>No image uploaded</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Update Product</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}


<!-- Store Modal -->
<div class="modal fade" id="storeModal" tabindex="-1" aria-labelledby="storeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="storeModalLabel">
          {% if has_store %}Edit Your Store{% else %}Create Your Store{% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" enctype="multipart/form-data" id="storeForm">
          {% csrf_token %}

          <!-- Store Name -->
          <div class="mb-3">
            <label for="id_name" class="form-label">Store Name *</label>
            <input type="text" class="form-control" id="id_name" name="name"
                   value="{% if has_store %}{{ request.user.store.name }}{% endif %}" required>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            <textarea class="form-control" id="id_description" name="description" rows="3">{% if has_store %}{{ request.user.store.description }}{% endif %}</textarea>
          </div>

          <!-- Store Logo -->
          <div class="mb-3">
            <label for="id_logo" class="form-label">Store Logo</label>
            <input type="file" class="form-control" id="id_logo" name="logo" accept="image/*">
            <div class="form-text">Max size: 5MB. Supported formats: JPG, PNG, GIF</div>

            {% if has_store and request.user.store.logo %}
            <div class="current-logo mt-2 text-center">
              <p>Current Logo:</p>
              <img src="{{ request.user.store.logo }}" class="img-thumbnail" style="max-height: 100px;">

            </div>
            {% else %}
            <div class="current-logo mt-2 text-center d-none">
              <img src="" class="img-thumbnail" style="max-height: 100px;">
            </div>
            {% endif %}
          </div>

          <!-- Address, City, Province, Is Active (same as before) -->
          <div class="mb-3">
            <label for="id_address" class="form-label">Address *</label>
            <input type="text" class="form-control" id="id_address" name="address" value="{% if has_store %}{{ request.user.store.address }}{% endif %}" required>
          </div>
          <div class="mb-3">
            <label for="id_city" class="form-label">City *</label>
            <input type="text" class="form-control" id="id_city" name="city" value="{% if has_store %}{{ request.user.store.city }}{% endif %}" required>
          </div>
          <div class="mb-3">
            <label for="id_province" class="form-label">Province *</label>
            <input type="text" class="form-control" id="id_province" name="province" value="{% if has_store %}{{ request.user.store.province }}{% endif %}" required>
          </div>

<!-- Latitude -->
<div class="mb-3">
    <label class="form-label">Latitude</label>
    <input type="text" class="form-control" name="latitude" value="{% if has_store %}{{ request.user.store.latitude }}{% endif %}" readonly>
</div>

<!-- Longitude -->
<div class="mb-3">
    <label class="form-label">Longitude</label>
    <input type="text" class="form-control" name="longitude" value="{% if has_store %}{{ request.user.store.longitude }}{% endif %}" readonly>
</div>


          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">{% if has_store %}Update Store{% else %}Create Store{% endif %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Toggle sidebar on mobile
        function toggleNav() {
            const sidebar = document.getElementById('sidebar');
            const burger = document.getElementById('burger');
            sidebar.classList.toggle('active');
            burger.classList.toggle('active');
        }
        
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Image preview for add product form
            $('#id_image_url').change(function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#imagePreview').attr('src', e.target.result).removeClass('d-none');
                    }
                    reader.readAsDataURL(file);
                }
            });
            
    // Handle add product form submission
            $('#addProductForm').on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                
                $.ajax({
                    url: "{% url 'add_product' %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message || 'An error occurred');
                        }
                    },
                    error: function(xhr) {
                        alert('An error occurred while adding the product');
                    }
                });
            });
        });
        
        // Search products
        function searchProduct() {
            const query = $('#searchBox').val().trim();
            if (!query) {
                alert('Please enter a search term');
                return;
            }
            
            $.getJSON("{% url 'search_products' %}?query=" + encodeURIComponent(query), function(data) {
                const tbody = $('tbody');
                tbody.empty();
                
                if (data.results.length === 0) {
                    tbody.append('<tr><td colspan="7" class="text-center">No products found</td></tr>');
                    return;
                }
                
                data.results.forEach(product => {
                    const row = `
                        <tr>
                            <td>${product.name}</td>
                            <td>${product.category || '-'}</td>
                            <td class="description" title="${product.description || ''}">${product.description ? product.description.substring(0, 50) + (product.description.length > 50 ? '...' : '') : '-'}</td>
                            <td>$${product.price}</td>
                            <td>${product.stock}</td>
                            <td><img class="tb-image" src="${product.image_url || '{% static 'img/no-image.png' %}'}" alt="${product.name}"></td>
                            <td>
                                <button class="btn btn-edit actions-btn" data-bs-toggle="modal" data-bs-target="#editProductModal${product.id}">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </button>
                                <button class="btn btn-delete actions-btn" onclick="confirmDelete(${product.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }).fail(function() {
                alert('Error searching products');
            });
        }
        
        // Confirm product deletion
        function confirmDelete(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                $.ajax({
                    url: `/delete_product/${productId}/`,
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message || 'Error deleting product');
                        }
                    },
                    error: function() {
                        alert('Error deleting product');
                    }
                });
            }
        }
        
        // Undo last action
        function undoAction() {
            if (!confirm('Are you sure you want to undo the last action?')) return;
            
            $.ajax({
                url: "{% url 'undo_last_action' %}",
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message || 'Nothing to undo');
                    }
                },
                error: function() {
                    alert('Error undoing action');
                }
            });
        }
        
        // Print products
        function printProducts() {
            const printWindow = window.open('', '_blank');
            const now = new Date();
            const dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            
            let html = `
                <html>
                <head>
                    <title>Product List</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; }
                        .header { display: flex; align-items: center; margin-bottom: 20px; }
                        .logo { width: 60px; height: 60px; margin-right: 20px; }
                        .date { margin-bottom: 20px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        img { max-width: 100px; max-height: 100px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="{% static 'img/PrintLogo.jpg' %}" class="logo" alt="Logo">
                        <h1>Product List - {{ request.user.store.name|default:'My Store' }}</h1>
                    </div>
                    <div class="date">Generated on: ${dateStr}</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Image</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Add product rows
            {% for product in products %}
            html += `
                <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ product.category.name|default:"-" }}</td>
                    <td>{{ product.description|default:"-" }}</td>
                    <td>₱{{ product.price }}</td>
                    <td>{{ product.stock }}</td>
                    <td><img src="{{ product.image_url|default:'/static/img/no-image.png' }}" alt="Product Image"></td>
                </tr>
            `;
            {% endfor %}
            
            html += `
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }


        $('#id_logo').change(function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const logoDiv = $('.current-logo');
            logoDiv.removeClass('d-none');
            logoDiv.find('img').attr('src', e.target.result);
            $('#logoClear').prop('checked', false);  // uncheck "remove" if user selects new file
        }
        reader.readAsDataURL(file);
    }
});



        $(document).ready(function() {
    $('#storeForm').on('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const url = "{% if has_store %}{% url 'update_store' %}{% else %}{% url 'create_store' %}{% endif %}";
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
        
        // Clear previous errors
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').text('');
        $('.alert-container').empty();
        
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Show success message and reload
                    $('.alert-container').html(
                        `<div class="alert alert-success alert-dismissible fade show">
                            <i class="fas fa-check-circle"></i> ${response.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`
                    );

                     $('#storeModal input[readonly][name="latitude"]').val(response.latitude);
                    $('#storeModal input[readonly][name="longitude"]').val(response.longitude);

                    setTimeout(() => location.reload(), 1500);
                } else {
                    // Show error message
                    let errorHtml = `<div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-circle"></i> ${response.message}`;
                    
                    // Add field errors if they exist
                    if (response.errors) {
                        errorHtml += '<ul class="mt-2 mb-0">';
                        for (const [field, error] of Object.entries(response.errors)) {
                            $(`#id_${field}`).addClass('is-invalid');
                            $(`#${field}-error`).text(error);
                            errorHtml += `<li>${field}: ${error}</li>`;
                        }
                        errorHtml += '</ul>';
                    }
                    
                    errorHtml += `<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
                    
                    $('.alert-container').html(errorHtml);
                }
            },
            error: function(xhr) {
                let errorMsg = 'An error occurred while processing your request';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMsg = response.message;
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                
                $('.alert-container').html(
                    `<div class="alert alert-danger alert-dismissible fade show">
                        <i class="fas fa-exclamation-circle"></i> ${errorMsg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`
                );
            },
            complete: function() {
                submitBtn.prop('disabled', false).html('{% if has_store %}Update Store{% else %}Create Store{% endif %}');
            }
        });
    });
});
    </script>
</body>
</html>